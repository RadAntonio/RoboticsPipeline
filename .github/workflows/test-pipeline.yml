name: Brev Connection Test

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-brev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Brev CLI
        run: |
          sudo bash -c "$(curl -fsSL https://raw.githubusercontent.com/brevdev/brev-cli/main/bin/install-latest.sh)"

      - name: Login to Brev
        run: echo "No" | brev login --token ${{ secrets.BREV_TOKEN }} --skip-browser

      - name: Start instance
        run: brev start test1-pipeline

      - name: Enter the VM
        run: brev shell test1-pipeline

      - name: 0. Basic Sanity Checks
        run: |
          cat <<'EOF' > step0.sh
          set -euo pipefail
          echo "== OS =="
          . /etc/os-release
          echo "$PRETTY_NAME"
          echo "== GPU / Driver (must work) =="
          nvidia-smi
          EOF
          cat step0.sh | brev shell test1-pipeline --bash "cat > step0.sh && bash step0.sh"

      - name: 1. System dependencies
        run: |
          cat <<'EOF' > step1.sh
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget gnupg ca-certificates \
            build-essential \
            python3-dev \
            ninja-build cmake pkg-config
          EOF
          cat step1.sh | brev shell test1-pipeline --bash "cat > step1.sh && bash step1.sh"

      - name: 2. Remove Ubuntu's nvidia-cuda-toolkit
        run: |
          cat <<'EOF' > step2.sh
          set -euo pipefail
          sudo apt-get purge -y nvidia-cuda-toolkit || true
          sudo apt-get autoremove -y || true
          EOF
          cat step2.sh | brev shell test1-pipeline --bash "cat > step2.sh && bash step2.sh"

      - name: 3. Install CUDA Toolkit 12.4
        run: |
          cat <<'EOF' > step3.sh
          set -euo pipefail
          UBU_VER="${VERSION_ID//./}"
          CUDA_REPO_URL="https://developer.download.nvidia.com/compute/cuda/repos/ubuntu${UBU_VER}/x86_64/cuda-keyring_1.1-1_all.deb"

          echo "== Installing CUDA repo keyring from: $CUDA_REPO_URL =="
          wget -q "$CUDA_REPO_URL" -O /tmp/cuda-keyring.deb
          sudo dpkg -i /tmp/cuda-keyring.deb
          sudo apt-get update

          echo "== Installing CUDA toolkit 12.4 =="
          sudo apt-get install -y cuda-toolkit-12-4
          EOF
          cat step3.sh | brev shell test1-pipeline --bash "cat > step3.sh && bash step3.sh"

      - name: 4. Make sure we use CUDA 12.4 in PATH
        run: |
          cat <<'EOF' > step4.sh
          set -euo pipefail
          if ! grep -q "cuda-12.4" ~/.bashrc; then
            {
              echo ""
              echo "# CUDA 12.4 (for GR00T + flash-attn)"
              echo "export CUDA_HOME=/usr/local/cuda-12.4"
              echo "export PATH=\$CUDA_HOME/bin:\$PATH"
              echo "export LD_LIBRARY_PATH=\$CUDA_HOME/lib64:\$LD_LIBRARY_PATH"
            } >> ~/.bashrc
          fi
          
          # Apply for current step verification
          export CUDA_HOME=/usr/local/cuda-12.4
          export PATH=$CUDA_HOME/bin:$PATH
          export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

          echo "== nvcc should be 12.4 now =="
          which nvcc
          nvcc --version
          EOF
          cat step4.sh | brev shell test1-pipeline --bash "cat > step4.sh && bash step4.sh"

      - name: 5. Install uv
        run: |
          cat <<'EOF' > step5.sh
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          
          # Load for verification
          source ~/.bashrc || true
          echo "== uv version =="
          uv --version
          EOF
          cat step5.sh | brev shell test1-pipeline --bash "cat > step5.sh && bash step5.sh"

      - name: 6. Clone GR00T
        run: |
          cat <<'EOF' > step6.sh
          set -euo pipefail
          cd ~
          # Remove if exists to allow re-run/idempotency
          rm -rf Isaac-GR00T
          git clone --recurse-submodules https://github.com/NVIDIA/Isaac-GR00T
          EOF
          cat step6.sh | brev shell test1-pipeline --bash "cat > step6.sh && bash step6.sh"

      - name: 7. Create env + install repo deps
        run: |
          cat <<'EOF' > step7.sh
          set -euo pipefail
          source ~/.bashrc || true
          cd ~/Isaac-GR00T
          uv sync --python 3.10
          uv pip install -e .
          EOF
          cat step7.sh | brev shell test1-pipeline --bash "cat > step7.sh && bash step7.sh"

      - name: 8. Install PyTorch CUDA 12.4 wheels
        run: |
          cat <<'EOF' > step8.sh
          set -euo pipefail
          source ~/.bashrc || true
          cd ~/Isaac-GR00T
          uv pip install --upgrade pip
          uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124

          echo "== Torch CUDA check =="
          uv run python - <<'PY'
          import torch
          print("torch:", torch.__version__)
          print("torch.version.cuda:", torch.version.cuda)
          print("cuda available:", torch.cuda.is_available())
          if torch.cuda.is_available():
              print("gpu:", torch.cuda.get_device_name(0))
          PY
          EOF
          cat step8.sh | brev shell test1-pipeline --bash "cat > step8.sh && bash step8.sh"

      - name: 9. Install flash-attn
        run: |
          cat <<'EOF' > step9.sh
          set -euo pipefail
          source ~/.bashrc || true
          cd ~/Isaac-GR00T
          
          # For A100/H100 usually, assuming 8.0+ is safe or desired
          export TORCH_CUDA_ARCH_LIST="8.0"
          export MAX_JOBS="$(nproc)"
          
          # Ensure CUDA is in path for this step as well
          export CUDA_HOME=/usr/local/cuda-12.4
          export PATH=$CUDA_HOME/bin:$PATH
          export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

          uv pip install ninja packaging
          uv pip install flash-attn --no-build-isolation --no-cache-dir

          echo "== flash-attn import check =="
          uv run python - <<'PY'
          import flash_attn
          print("flash_attn OK:", flash_attn.__version__)
          PY
          EOF
          cat step9.sh | brev shell test1-pipeline --bash "cat > step9.sh && bash step9.sh"

      - name: Setup complete message
        run: |
          brev shell test1-pipeline --bash 'echo "== Setup complete. == Repo at: ~/Isaac-GR00T"'


      - name: Exit VM
        run: exit

      - name: Stop instance
        run: brev stop test1-pipeline