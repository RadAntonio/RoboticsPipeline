name: Brev Connection Test

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-brev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Brev CLI
        run: |
          sudo bash -c "$(curl -fsSL https://raw.githubusercontent.com/brevdev/brev-cli/main/bin/install-latest.sh)"

      - name: Login to Brev
        run: echo "No" | brev login --token ${{ secrets.BREV_TOKEN }} --skip-browser

      - name: Start instance
        run: brev start test-pipeline

      - name: Wait for instance
        run: |
          i=0
          while [ $i -lt 60 ]; do
            i=$((i + 1))
            STATUS=$(brev ls | grep test-pipeline | awk '{print $2}')
            SHELL_STATUS=$(brev ls | grep test-pipeline | awk '{print $4}')
            echo "Attempt $i/60: STATUS=$STATUS, SHELL=$SHELL_STATUS"
            if [ "$STATUS" = "RUNNING" ] && [ "$SHELL_STATUS" = "READY" ]; then
              echo "Instance is ready!"
              break
            fi
            sleep 10
          done

      - name: Enter the VM
        run: brev shell test-pipeline

      - name: Exit VM
        run: exit

      - name: Stop instance
        run: brev stop test-pipeline