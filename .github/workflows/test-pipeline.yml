name: Brev Connection Test

on:
  workflow_dispatch:

jobs:
  test-brev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Brev CLI
        run: |
          sudo bash -c "$(curl -fsSL https://raw.githubusercontent.com/brevdev/brev-cli/main/bin/install-latest.sh)"

      - name: Login to Brev
        run: echo "No" | brev login --token ${{ secrets.BREV_TOKEN }} --skip-browser

      - name: Enter Brev with shell to create ssh config
        run: brev shell test1-pipeline

      - name: Step 0 - Basic sanity checks
        run: ssh -F ~/.brev/ssh_config test1-pipeline "echo == OS ==;
          . /etc/os-release;
          echo \$PRETTY_NAME;
          echo == GPU / Driver ==;
          nvidia-smi
          "

      - name: Step 1 - System dependencies
        run: ssh -F ~/.brev/ssh_config test1-pipeline "sudo apt-get update;
          sudo apt-get install -y git curl wget gnupg ca-certificates build-essential python3-dev ninja-build cmake pkg-config"

      - name: Step 2 - Remove Ubuntu's nvidia-cuda-toolkit
        run: ssh -F ~/.brev/ssh_config test1-pipeline "sudo apt-get purge -y nvidia-cuda-toolkit || true;
          sudo apt-get autoremove -y || true"

      - name: Step 3 - Install NVIDIA CUDA Toolkit 12.4
        run: ssh -F ~/.brev/ssh_config test1-pipeline "sudo apt-get update;
          . /etc/os-release;
          UBU_VER=\"\${VERSION_ID//./}\";
          CUDA_REPO_URL=https://developer.download.nvidia.com/compute/cuda/repos/ubuntu\${UBU_VER}/x86_64/cuda-keyring_1.1-1_all.deb;
          echo == Installing CUDA repo keyring from \$CUDA_REPO_URL ==;
          wget -q \$CUDA_REPO_URL -O /tmp/cuda-keyring.deb;
          sudo dpkg -i /tmp/cuda-keyring.deb;
          sudo apt-get update;
          echo == Installing CUDA toolkit 12.4 ==;
          sudo apt-get install -y cuda-toolkit-12-4;
          "

      - name: Step 4 - Make sure we use CUDA 12.4 in PATH
        run: ssh -F ~/.brev/ssh_config test1-pipeline "echo == PATH ==;
          if ! grep -q \"cuda-12.4\" ~/.bashrc; then
          {
          echo \"\";
          echo \"# CUDA 12.4 (for GR00T + flash-attn)\";
          echo \"export CUDA_HOME=/usr/local/cuda-12.4\";
          echo \"export PATH=\\\$CUDA_HOME/bin:\\\$PATH\";
          echo \"export LD_LIBRARY_PATH=\\\$CUDA_HOME/lib64:\\\$LD_LIBRARY_PATH\";
          } >> ~/.bashrc;
          fi;
          export CUDA_HOME=/usr/local/cuda-12.4;
          export PATH=\$CUDA_HOME/bin:\$PATH;
          export LD_LIBRARY_PATH=\$CUDA_HOME/lib64:\$LD_LIBRARY_PATH;
          echo == nvcc should be 12.4 now ==;
          which nvcc;
          nvcc --version;
          "

      - name: Step 5 - Install uv
        run: ssh -F ~/.brev/ssh_config test1-pipeline "curl -LsSf https://astral.sh/uv/install.sh | sh;
          ~/.local/bin/uv --version;
          "

      - name: Step 6 - Clone GR00T
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~;
          if [ ! -d Isaac-GR00T ]; then
          git clone --recurse-submodules https://github.com/NVIDIA/Isaac-GR00T;
          else
          cd Isaac-GR00T && git pull;
          fi;
          "

      - name: Step 7 - Create env + install repo deps
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          ~/.local/bin/uv sync --python 3.10;
          ~/.local/bin/uv pip install -e .;
          "

      - name: Step 8 - Install PyTorch CUDA 12.4 wheels (cu124)
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          ~/.local/bin/uv pip install --upgrade pip;
          ~/.local/bin/uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124;
          echo == Torch CUDA check ==;
          ~/.local/bin/uv run python -c 'import torch; print(\"torch:\", torch.__version__); print(\"cuda available:\", torch.cuda.is_available())'
          "

      - name: Step 9 - Install flash-attn
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          export TORCH_CUDA_ARCH_LIST=\"8.0\";
          export MAX_JOBS=\$(nproc);
          ~/.local/bin/uv pip install ninja packaging;
          ~/.local/bin/uv pip install flash-attn --no-build-isolation --no-cache-dir;
          echo == flash-attn import check ==;
          ~/.local/bin/uv run python -c 'import flash_attn; print(\"flash_attn OK:\", flash_attn.__version__)';
          echo == Setup complete. ==;
          "

      - name: Step 10 - Install Huggingface
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          ~/.local/bin/uv pip install huggingface-hub hf_transfer;
          echo 'export HF_TOKEN=\"${{ secrets.HF_TOKEN }}\"' >> ~/.bashrc;
          echo 'export HF_HUB_ENABLE_HF_TRANSFER=1' >> ~/.bashrc;
          export HF_TOKEN=\"${{ secrets.HF_TOKEN }}\";
          export HF_HUB_ENABLE_HF_TRANSFER=1;
          ~/.local/bin/uv run hf auth whoami;
          "

      - name: Step 11 - Download GR00T model
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          ~/.local/bin/uv run hf download nvidia/GR00T-N1.6-3B;
          "

      - name: Step 12 - Clone Modality Files Repo
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~;
          if [ ! -d modality_files ]; then
          git clone https://huggingface.co/datasets/VoicAndrei/modality_files;
          else
          cd modality_files && git pull;
          fi;"

      #CHESTII CARE DEPIND DE CEVA
      - name: Step 13 - Download Dataset
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          ~/.local/bin/uv run hf download VoicAndrei/so100_test_blocks --repo-type dataset --local-dir ./hf_datasets/so100_test_blocks;
          "
      - name: Step 14 - Run finetune
        run: ssh -F ~/.brev/ssh_config test1-pipeline "cd ~/Isaac-GR00T;
          export NUM_GPUS=1;
          CUDA_VISIBLE_DEVICES=0 ~/.local/bin/uv run python gr00t/experiment/launch_finetune.py \
            --base_model_path nvidia/GR00T-N1.6-3B \
            --dataset_path ./hf_datasets/so100_test_blocks \
            --modality_config_path ~/modality_files/so100_top_wrist_config.py \
            --embodiment_tag NEW_EMBODIMENT \
            --num_gpus \$NUM_GPUS \
            --output_dir /tmp/so100_top_wrist_finetune \
            --save_steps 1000 \
            --save_total_limit 5 \
            --max_steps 10000 \
            --warmup_ratio 0.05 \
            --weight_decay 1e-5 \
            --learning_rate 1e-4 \
            --global_batch_size 32 \
            --color_jitter_params brightness 0.3 contrast 0.4 saturation 0.5 hue 0.08 \
            --dataloader_num_workers 4;
          "

      